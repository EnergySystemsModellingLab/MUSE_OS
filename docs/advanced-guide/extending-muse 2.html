
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extending MUSE &#8212; MUSE Documentation 0.8 documentation</title>
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Further extending MUSE" href="further-extending-muse.html" />
    <link rel="prev" title="Advanced guide" href="index.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="further-extending-muse.html" title="Further extending MUSE"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="Advanced guide"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">MUSE Documentation 0.8 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Advanced guide</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Extending MUSE</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container,
div.nbinput.container div.prompt,
div.nbinput.container div.input_area,
div.nbinput.container div[class*=highlight],
div.nbinput.container div[class*=highlight] pre,
div.nboutput.container,
div.nboutput.container div.prompt,
div.nboutput.container div.output_area,
div.nboutput.container div[class*=highlight],
div.nboutput.container div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    background: #f5f5f5;
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}
</style>
<div class="section" id="Extending-MUSE">
<h1>Extending MUSE<a class="headerlink" href="#Extending-MUSE" title="Permalink to this headline">¶</a></h1>
<p>One key feature of the generalized sector’s implementation is that it should be easy to extend. As such, MUSE can be made to run custom python functions, as long as these inputs and output of the function follow a standard specific to each step. We will look at a few here.</p>
<p>Below is a list of possible hooks, referenced by their implementation in the MUSE model:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">register_interaction_net</span></code> in <code class="docutils literal notranslate"><span class="pre">muse.interactions</span></code>: a list of lists of agents that interact together.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">register_agent_interaction</span></code> in <code class="docutils literal notranslate"><span class="pre">muse.interactions</span></code>: Given a list of interacting agents, perform the interaction.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">register_production</span></code> in <code class="docutils literal notranslate"><span class="pre">muse.production</span></code>: A method to compute the production from a sector, given the demand and the capacity.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">register_initial_asset_transform</span></code> in <code class="docutils literal notranslate"><span class="pre">muse.hooks</span></code>: Allows any kind of transformation to be applied to the assets of an agent, prior to investing.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">register_final_asset_transform</span></code> in <code class="docutils literal notranslate"><span class="pre">muse.hooks</span></code>: After computing the investment, this sets the assets that will be owned by the agents.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">register_demand_share</span></code> in <code class="docutils literal notranslate"><span class="pre">muse.demand_share</span></code>: During agent investment, this is the share of the demand that an agent will try and satisfy.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">register_filter</span></code> in <code class="docutils literal notranslate"><span class="pre">muse.filters</span></code>: A filter to remove technologies from consideration, during agent investment.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">register_objective</span></code> in <code class="docutils literal notranslate"><span class="pre">muse.objectives</span></code>: A quantity which allows an agent to compare technologies during investment.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">register_decision</span></code> in <code class="docutils literal notranslate"><span class="pre">muse.decisions</span></code>: A transformation applied to aggregate multiple objectives into a single objective during agent investment, e.g. via a weighted sum.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">register_investment</span></code> in <code class="docutils literal notranslate"><span class="pre">muse.investment</span></code>: During agent investment, matches the demand for future investment using the decision metric above.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">register_output_quantity</span></code> in <code class="docutils literal notranslate"><span class="pre">muse.output.sector</span></code>: A sectorial quantity to output for postmortem analysis.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">register_output_sink</span></code> in <code class="docutils literal notranslate"><span class="pre">muse.outputs</span></code>: A <em>place</em> to store an output quantity, e.g. a file with a given format, a database on premise or on the cloud, etc…</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">register_carbon_budget_fitter</span></code> in <code class="docutils literal notranslate"><span class="pre">muse.carbon_budget</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">register_carbon_budget_method</span></code> in <code class="docutils literal notranslate"><span class="pre">muse.carbon_budget</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">register_sector</span></code>: Registers a function that can create a sector from a muse configuration object.</p></li>
</ul>
<div class="section" id="Extending-outputs">
<h2>Extending outputs<a class="headerlink" href="#Extending-outputs" title="Permalink to this headline">¶</a></h2>
<p>MUSE can be used to save custom quantities as well as data for analysis. There are two steps to this process:</p>
<ul class="simple">
<li><p>Computing the quantity of interest</p></li>
<li><p>Store the quantity of interest in a sink</p></li>
</ul>
<p>In practice, this means that we can compute any quantity, such as capacity or consumption of an energy source and save it to a csv file, or a netcdf file.</p>
<div class="section" id="Output-extension">
<h3>Output extension<a class="headerlink" href="#Output-extension" title="Permalink to this headline">¶</a></h3>
<p>To demonstrate this, we will compute a new edited quantity of consumption, then save it as a text file.</p>
<p>The current implementation of the quantity of consumption found in <code class="docutils literal notranslate"><span class="pre">muse.outputs.sector</span></code> filters out values of 0. In this example, we would like to maintain the values of 0, but do not want to edit the source code of MUSE.</p>
<p>This is rather simple to do using MUSE’s hooks.</p>
<p>First we create a new function called <code class="docutils literal notranslate"><span class="pre">consumption_zero</span></code> as follows:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">muse.outputs.sector</span> <span class="kn">import</span> <span class="n">register_output_quantity</span>
<span class="kn">from</span> <span class="nn">muse.outputs.sector</span> <span class="kn">import</span> <span class="n">market_quantity</span>
<span class="kn">from</span> <span class="nn">xarray</span> <span class="kn">import</span> <span class="n">Dataset</span><span class="p">,</span> <span class="n">DataArray</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Text</span>

<span class="nd">@register_output_quantity</span>
<span class="k">def</span> <span class="nf">consumption_zero</span><span class="p">(</span>
    <span class="n">market</span><span class="p">:</span> <span class="n">Dataset</span><span class="p">,</span>
    <span class="n">capacity</span><span class="p">:</span> <span class="n">DataArray</span><span class="p">,</span>
    <span class="n">technologies</span><span class="p">:</span> <span class="n">Dataset</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Current consumption.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">market_quantity</span><span class="p">(</span><span class="n">market</span><span class="o">.</span><span class="n">consumption</span><span class="p">,</span> <span class="n">sum_over</span><span class="o">=</span><span class="s2">&quot;timeslice&quot;</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;consumption&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
        <span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
</div>
<p>The function we created takes three arguments. These arguments (<code class="docutils literal notranslate"><span class="pre">market</span></code>, <code class="docutils literal notranslate"><span class="pre">capacity</span></code> and <code class="docutils literal notranslate"><span class="pre">technology</span></code>) are mandatory for the <code class="docutils literal notranslate"><span class="pre">&#64;register_output_quantity</span></code> hook. Other hooks require different arguments.</p>
<p>Whilst this function is very similar to the <code class="docutils literal notranslate"><span class="pre">consumption</span></code> function in <code class="docutils literal notranslate"><span class="pre">muse.outputs.sector</span></code>, we have modified it slightly by allowing for values of <code class="docutils literal notranslate"><span class="pre">0</span></code>.</p>
<p>The important part of this function is the <code class="docutils literal notranslate"><span class="pre">&#64;register_output_quantity</span></code> decorator. This decorator ensures that this new quantity is addressable in the TOML file. Notice that we did not need to edit the source code to create our new function.</p>
<p>Next, we can create a sink to save the output quantity previously registered. For this example, this sink will simply dump the quantity it is given to a file, with the “Hello world!” message:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Text</span>
<span class="kn">from</span> <span class="nn">muse.outputs.sinks</span> <span class="kn">import</span> <span class="n">register_output_sink</span><span class="p">,</span> <span class="n">sink_to_file</span>

<span class="nd">@register_output_sink</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;txt&quot;</span><span class="p">)</span>
<span class="nd">@sink_to_file</span><span class="p">(</span><span class="s2">&quot;.txt&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">text_dump</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="n">Text</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
    <span class="n">Path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hello world!</span><span class="se">\n\n</span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The code above makes use of two dectorators: <code class="docutils literal notranslate"><span class="pre">&#64;register_output_sink</span></code> and <code class="docutils literal notranslate"><span class="pre">&#64;sink_to_file</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">&#64;register_output_sink</span></code> registers the function with MUSE, so that the sink is addressable from a TOML file. The second one, <code class="docutils literal notranslate"><span class="pre">&#64;sink_to_file</span></code>, is optional. This adds some nice-to-have features to sinks that are files. For example, a way to specify filenames and check that files cannot be overwritten, unless explicitly allowed to.</p>
<p>Next, we want to modify the TOML file to actually use this output type. To do this, we add a section to the output table:</p>
<div class="highlight-toml notranslate"><div class="highlight"><pre><span></span><span class="k">[[sectors.residential.outputs]]</span>
<span class="n">quantity</span> <span class="o">=</span> <span class="s">&quot;consumption_zero&quot;</span>
<span class="n">sink</span> <span class="o">=</span> <span class="s">&quot;txt&quot;</span>
<span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;{cwd}/{default_output_dir}/{Sector}{Quantity}{year}{suffix}&quot;</span>
</pre></div>
</div>
<p>The last line above allows us to specify the name of the file. We could also use <code class="docutils literal notranslate"><span class="pre">sector</span></code> above or <code class="docutils literal notranslate"><span class="pre">quantity</span></code>.</p>
<p>There can be as many sections of this kind as we like in the TOML file, which allow for multiple outputs.</p>
<p>Next, we first copy the default model provided with muse to a local subfolder called “model”. Then we read the <code class="docutils literal notranslate"><span class="pre">settings.toml</span></code> file and modify it using python. You may prefer to modify the <code class="docutils literal notranslate"><span class="pre">settings.toml</span></code> file using your favorite text editor. However, modifying the file programmatically allows us to routinely run this notebook as part of MUSE’s test suite and check that the tutorial it is still up to date.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">toml</span> <span class="kn">import</span> <span class="n">load</span><span class="p">,</span> <span class="n">dump</span>
<span class="kn">from</span> <span class="nn">muse</span> <span class="kn">import</span> <span class="n">examples</span>

<span class="n">model_path</span> <span class="o">=</span> <span class="n">examples</span><span class="o">.</span><span class="n">copy_model</span><span class="p">(</span><span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">settings</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="n">model_path</span> <span class="o">/</span> <span class="s2">&quot;settings.toml&quot;</span><span class="p">)</span>
<span class="n">new_output</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;quantity&quot;</span><span class="p">:</span> <span class="s2">&quot;consumption_zero&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sink&quot;</span><span class="p">:</span>  <span class="s2">&quot;txt&quot;</span><span class="p">,</span>
    <span class="s2">&quot;overwrite&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{cwd}</span><span class="s2">/</span><span class="si">{default_output_dir}</span><span class="s2">/</span><span class="si">{Sector}{Quantity}{year}{suffix}</span><span class="s2">&quot;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">settings</span><span class="p">[</span><span class="s2">&quot;sectors&quot;</span><span class="p">][</span><span class="s2">&quot;residential&quot;</span><span class="p">][</span><span class="s2">&quot;outputs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_output</span><span class="p">)</span>
<span class="n">dump</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="p">(</span><span class="n">model_path</span> <span class="o">/</span> <span class="s2">&quot;modified_settings.toml&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;w&quot;</span><span class="p">))</span>
<span class="n">settings</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
-- 2020-11-26 16:49:14 - muse.sectors.register - INFO
Sector legacy registered.

-- 2020-11-26 16:49:14 - muse.sectors.register - INFO
Sector preset registered, with alias presets.

-- 2020-11-26 16:49:14 - muse.sectors.register - INFO
Sector default registered.

</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;time_framework&#39;: [2020, 2025, 2030, 2035, 2040, 2045, 2050],
 &#39;foresight&#39;: 5,
 &#39;regions&#39;: [&#39;R1&#39;],
 &#39;interest_rate&#39;: 0.1,
 &#39;interpolation_mode&#39;: &#39;Active&#39;,
 &#39;log_level&#39;: &#39;info&#39;,
 &#39;equilibrium_variable&#39;: &#39;demand&#39;,
 &#39;maximum_iterations&#39;: 100,
 &#39;tolerance&#39;: 0.1,
 &#39;tolerance_unmet_demand&#39;: -0.1,
 &#39;outputs&#39;: [{&#39;quantity&#39;: &#39;prices&#39;,
   &#39;sink&#39;: &#39;aggregate&#39;,
   &#39;filename&#39;: &#39;{cwd}/{default_output_dir}/MCA{Quantity}.csv&#39;},
  {&#39;quantity&#39;: &#39;capacity&#39;,
   &#39;sink&#39;: &#39;aggregate&#39;,
   &#39;filename&#39;: &#39;{cwd}/{default_output_dir}/MCA{Quantity}.csv&#39;}],
 &#39;carbon_budget_control&#39;: {&#39;budget&#39;: []},
 &#39;global_input_files&#39;: {&#39;projections&#39;: &#39;{path}/input/Projections.csv&#39;,
  &#39;global_commodities&#39;: &#39;{path}/input/GlobalCommodities.csv&#39;},
 &#39;sectors&#39;: {&#39;residential&#39;: {&#39;type&#39;: &#39;default&#39;,
   &#39;priority&#39;: 1,
   &#39;dispatch_production&#39;: &#39;share&#39;,
   &#39;technodata&#39;: &#39;{path}/technodata/residential/Technodata.csv&#39;,
   &#39;commodities_in&#39;: &#39;{path}/technodata/residential/CommIn.csv&#39;,
   &#39;commodities_out&#39;: &#39;{path}/technodata/residential/CommOut.csv&#39;,
   &#39;subsectors&#39;: {&#39;retro_and_new&#39;: {&#39;agents&#39;: &#39;{path}/technodata/Agents.csv&#39;,
     &#39;existing_capacity&#39;: &#39;{path}/technodata/residential/ExistingCapacity.csv&#39;,
     &#39;lpsolver&#39;: &#39;scipy&#39;,
     &#39;constraints&#39;: [&#39;max_production&#39;,
      &#39;max_capacity_expansion&#39;,
      &#39;demand&#39;,
      &#39;search_space&#39;],
     &#39;demand_share&#39;: &#39;new_and_retro&#39;,
     &#39;forecast&#39;: 5}},
   &#39;outputs&#39;: [{&#39;filename&#39;: &#39;{cwd}/{default_output_dir}/{Sector}/{Quantity}/{year}{suffix}&#39;,
     &#39;quantity&#39;: &#39;capacity&#39;,
     &#39;sink&#39;: &#39;csv&#39;,
     &#39;overwrite&#39;: True},
    {&#39;filename&#39;: &#39;{cwd}/{default_output_dir}/{Sector}/{Quantity}/{year}{suffix}&#39;,
     &#39;quantity&#39;: {&#39;name&#39;: &#39;supply&#39;,
      &#39;sum_over&#39;: &#39;timeslice&#39;,
      &#39;drop&#39;: [&#39;comm_usage&#39;, &#39;units_prices&#39;]},
     &#39;sink&#39;: &#39;csv&#39;,
     &#39;overwrite&#39;: True},
    {&#39;quantity&#39;: &#39;consumption_zero&#39;,
     &#39;sink&#39;: &#39;txt&#39;,
     &#39;overwrite&#39;: True,
     &#39;filename&#39;: &#39;{cwd}/{default_output_dir}/{Sector}{Quantity}{year}{suffix}&#39;}],
   &#39;interactions&#39;: [{&#39;net&#39;: &#39;new_to_retro&#39;, &#39;interaction&#39;: &#39;transfer&#39;}]},
  &#39;power&#39;: {&#39;type&#39;: &#39;default&#39;,
   &#39;priority&#39;: 2,
   &#39;dispatch_production&#39;: &#39;share&#39;,
   &#39;technodata&#39;: &#39;{path}/technodata/power/Technodata.csv&#39;,
   &#39;commodities_in&#39;: &#39;{path}/technodata/power/CommIn.csv&#39;,
   &#39;commodities_out&#39;: &#39;{path}/technodata/power/CommOut.csv&#39;,
   &#39;subsectors&#39;: {&#39;retro_and_new&#39;: {&#39;agents&#39;: &#39;{path}/technodata/Agents.csv&#39;,
     &#39;existing_capacity&#39;: &#39;{path}/technodata/power/ExistingCapacity.csv&#39;,
     &#39;lpsolver&#39;: &#39;scipy&#39;}},
   &#39;outputs&#39;: [{&#39;filename&#39;: &#39;{cwd}/{default_output_dir}/{Sector}/{Quantity}/{year}{suffix}&#39;,
     &#39;quantity&#39;: &#39;capacity&#39;,
     &#39;sink&#39;: &#39;csv&#39;,
     &#39;overwrite&#39;: True}],
   &#39;interactions&#39;: [{&#39;net&#39;: &#39;new_to_retro&#39;, &#39;interaction&#39;: &#39;transfer&#39;}]},
  &#39;gas&#39;: {&#39;type&#39;: &#39;default&#39;,
   &#39;priority&#39;: 3,
   &#39;dispatch_production&#39;: &#39;share&#39;,
   &#39;technodata&#39;: &#39;{path}/technodata/gas/Technodata.csv&#39;,
   &#39;commodities_in&#39;: &#39;{path}/technodata/gas/CommIn.csv&#39;,
   &#39;commodities_out&#39;: &#39;{path}/technodata/gas/CommOut.csv&#39;,
   &#39;subsectors&#39;: {&#39;retro_and_new&#39;: {&#39;agents&#39;: &#39;{path}/technodata/Agents.csv&#39;,
     &#39;existing_capacity&#39;: &#39;{path}/technodata/gas/ExistingCapacity.csv&#39;,
     &#39;lpsolver&#39;: &#39;scipy&#39;}},
   &#39;outputs&#39;: [{&#39;filename&#39;: &#39;{cwd}/{default_output_dir}/{Sector}/{Quantity}/{year}{suffix}&#39;,
     &#39;quantity&#39;: &#39;capacity&#39;,
     &#39;sink&#39;: &#39;csv&#39;,
     &#39;overwrite&#39;: True}],
   &#39;interactions&#39;: [{&#39;net&#39;: &#39;new_to_retro&#39;, &#39;interaction&#39;: &#39;transfer&#39;}]},
  &#39;residential_presets&#39;: {&#39;type&#39;: &#39;presets&#39;,
   &#39;priority&#39;: 0,
   &#39;consumption_path&#39;: &#39;{path}/technodata/preset/*Consumption.csv&#39;}},
 &#39;timeslices&#39;: {&#39;all-year&#39;: {&#39;all-week&#39;: {&#39;night&#39;: 1460,
    &#39;morning&#39;: 1460,
    &#39;afternoon&#39;: 1460,
    &#39;early-peak&#39;: 1460,
    &#39;late-peak&#39;: 1460,
    &#39;evening&#39;: 1460}},
  &#39;level_names&#39;: [&#39;month&#39;, &#39;day&#39;, &#39;hour&#39;]}}
</pre></div></div>
</div>
<p>We can now run the simulation. There are two ways to do this. From the command-line, where we can do:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python3</span> <span class="o">-</span><span class="n">m</span> <span class="n">muse</span> <span class="n">data</span><span class="o">/</span><span class="n">commercial</span><span class="o">/</span><span class="n">modified_settings</span><span class="o">.</span><span class="n">toml</span>
</pre></div>
</div>
<p>(note that slashes may be the other way on Windows). Or directly from the notebook:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">muse.mca</span> <span class="kn">import</span> <span class="n">MCA</span>
<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;muse&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">mca</span> <span class="o">=</span> <span class="n">MCA</span><span class="o">.</span><span class="n">factory</span><span class="p">(</span><span class="n">model_path</span> <span class="o">/</span> <span class="s2">&quot;modified_settings.toml&quot;</span><span class="p">)</span>
<span class="n">mca</span><span class="o">.</span><span class="n">run</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
-- 2020-11-26 16:49:20 - muse.mca - WARNING
Check growth constraints for wind.

-- 2020-11-26 16:49:25 - muse.mca - WARNING
Check growth constraints for wind.

-- 2020-11-26 16:49:29 - muse.mca - WARNING
Check growth constraints for wind.

-- 2020-11-26 16:49:34 - muse.mca - WARNING
Check growth constraints for wind.

-- 2020-11-26 16:49:39 - muse.mca - WARNING
Check growth constraints for wind.

-- 2020-11-26 16:49:43 - muse.mca - WARNING
Check growth constraints for wind.

-- 2020-11-26 16:49:47 - muse.mca - WARNING
Check growth constraints for wind.

-- 2020-11-26 16:49:53 - muse.mca - WARNING
Check growth constraints for wind.

-- 2020-11-26 16:49:58 - muse.mca - WARNING
Check growth constraints for wind.

-- 2020-11-26 16:50:05 - muse.mca - WARNING
Check growth constraints for wind.

-- 2020-11-26 16:50:10 - muse.mca - WARNING
Check growth constraints for wind.

-- 2020-11-26 16:50:15 - muse.mca - WARNING
Check growth constraints for wind.

-- 2020-11-26 16:50:20 - muse.mca - WARNING
Check growth constraints for wind.

</pre></div></div>
</div>
<p>We can now check that the simulation has created the files that we expect. We also check that our “Hello, world!” message has printed:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">all_txt_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">((</span><span class="n">Path</span><span class="p">()</span> <span class="o">/</span> <span class="s2">&quot;Results&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;Residential*.txt&quot;</span><span class="p">))</span>
<span class="k">assert</span> <span class="s2">&quot;Hello world!&quot;</span> <span class="ow">in</span> <span class="n">all_txt_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>
<span class="n">all_txt_files</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[PosixPath(&#39;Results/ResidentialConsumption_Zero2020.txt&#39;),
 PosixPath(&#39;Results/ResidentialConsumption_Zero2025.txt&#39;),
 PosixPath(&#39;Results/ResidentialConsumption_Zero2030.txt&#39;),
 PosixPath(&#39;Results/ResidentialConsumption_Zero2035.txt&#39;),
 PosixPath(&#39;Results/ResidentialConsumption_Zero2040.txt&#39;),
 PosixPath(&#39;Results/ResidentialConsumption_Zero2045.txt&#39;),
 PosixPath(&#39;Results/ResidentialConsumption_Zero2050.txt&#39;)]
</pre></div></div>
</div>
<p>Our model output the files we were expecting and passed the <code class="docutils literal notranslate"><span class="pre">assert</span></code> statement, meaning that it could find the “Hello world!” messages in the outputs.</p>
</div>
</div>
<div class="section" id="Adding-TOML-parameters-to-the-outputs">
<h2>Adding TOML parameters to the outputs<a class="headerlink" href="#Adding-TOML-parameters-to-the-outputs" title="Permalink to this headline">¶</a></h2>
<p>It would be useful if we could pass parameters from the TOML file to our new functions <code class="docutils literal notranslate"><span class="pre">consumption_zero</span></code> and <code class="docutils literal notranslate"><span class="pre">text_dump</span></code>. For example, in our previous iteration the consumption output was aggregating the data by <code class="docutils literal notranslate"><span class="pre">&quot;timeslice&quot;</span></code>, by hardcoding the variable. We can pass a parameter which could do this by setting the <code class="docutils literal notranslate"><span class="pre">sum_over</span></code> parameter to be <code class="docutils literal notranslate"><span class="pre">True</span></code>. In addition, we could change the message output by a new <code class="docutils literal notranslate"><span class="pre">text_dump</span></code> function.</p>
<p>Not all hooks are this flexible (for historical reasons, rather than any intrinsic difficulty). However, for outputs, we can do this as follows:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nd">@register_output_quantity</span><span class="p">(</span><span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">consumption_zero</span><span class="p">(</span>
    <span class="n">market</span><span class="p">:</span> <span class="n">Dataset</span><span class="p">,</span>
    <span class="n">capacity</span><span class="p">:</span> <span class="n">DataArray</span><span class="p">,</span>
    <span class="n">technologies</span><span class="p">:</span> <span class="n">Dataset</span><span class="p">,</span>
    <span class="n">sum_over</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Text</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">drop</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Text</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">rounding</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Current consumption.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">market_quantity</span><span class="p">(</span><span class="n">market</span><span class="o">.</span><span class="n">consumption</span><span class="p">,</span> <span class="n">sum_over</span><span class="o">=</span><span class="n">sum_over</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="n">drop</span><span class="p">)</span>
        <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;consumption&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
        <span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">rounding</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="nd">@register_output_sink</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;txt&quot;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@sink_to_file</span><span class="p">(</span><span class="s2">&quot;.txt&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">text_dump</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">filename</span><span class="p">:</span> <span class="n">Text</span><span class="p">,</span>
    <span class="n">msg</span> <span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Text</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Hello, world!&quot;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
    <span class="n">Path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="se">\n\n</span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We simply added parameters as arguments to both of our functions: <code class="docutils literal notranslate"><span class="pre">consumption_zero</span></code> and <code class="docutils literal notranslate"><span class="pre">text_dump</span></code>.</p>
<p>Note: The overwrite argument allows us to overwrite previously defined registered functions. This is useful in a notebook such as this. But it should not be used in general. If overwrite were false, then the code would issue a warning and it would leave the TOML to refer to the original functions at the beginning of the notebook. This is useful when using custom modules.</p>
<p>Now we can modify the output section to take additional arguments:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[[</span><span class="n">sectors</span><span class="o">.</span><span class="n">commercial</span><span class="o">.</span><span class="n">outputs</span><span class="p">]]</span>
<span class="n">quantity</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;consumption_zero&quot;</span>
<span class="n">quantity</span><span class="o">.</span><span class="n">sum_over</span> <span class="o">=</span> <span class="s2">&quot;timeslice&quot;</span>
<span class="n">sink</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;txt&quot;</span>
<span class="n">sink</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{cwd}</span><span class="s2">/</span><span class="si">{default_output_dir}</span><span class="s2">/</span><span class="si">{Sector}{Quantity}{year}{suffix}</span><span class="s2">&quot;</span>
<span class="n">sink</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Hello, you!&quot;</span>
<span class="n">sink</span><span class="o">.</span><span class="n">overwrite</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
<p>Here, we still want to use the <code class="docutils literal notranslate"><span class="pre">consumption_zero</span></code> function and the <code class="docutils literal notranslate"><span class="pre">txt</span></code> sink. But we would like to change the message from “Hello world!” to “Hello you!” within the <code class="docutils literal notranslate"><span class="pre">TOML</span></code> file.</p>
<p>Now, both sink and quantity are dictionaries which can take any number of arguments. Previously, we were using a shorthand for convenience. Again, we create a new settings file, and run this with our new parameters, which interface with our new functions.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">toml</span> <span class="kn">import</span> <span class="n">load</span><span class="p">,</span> <span class="n">dump</span>
<span class="kn">from</span> <span class="nn">muse</span> <span class="kn">import</span> <span class="n">examples</span>

<span class="n">model_path</span> <span class="o">=</span> <span class="n">examples</span><span class="o">.</span><span class="n">copy_model</span><span class="p">(</span><span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">settings</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="n">model_path</span> <span class="o">/</span> <span class="s2">&quot;settings.toml&quot;</span><span class="p">)</span>
<span class="n">settings</span><span class="p">[</span><span class="s2">&quot;sectors&quot;</span><span class="p">][</span><span class="s2">&quot;residential&quot;</span><span class="p">][</span><span class="s2">&quot;outputs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s2">&quot;quantity&quot;</span><span class="p">:{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;consumption_zero&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sum_over&quot;</span><span class="p">:</span> <span class="s2">&quot;timeslice&quot;</span>
        <span class="p">},</span>
        <span class="s2">&quot;sink&quot;</span><span class="p">:{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;txt&quot;</span><span class="p">,</span>
            <span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{cwd}</span><span class="s2">/</span><span class="si">{default_output_dir}</span><span class="s2">/</span><span class="si">{Sector}{Quantity}{year}{suffix}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;msg&quot;</span><span class="p">:</span> <span class="s2">&quot;Hello, you!&quot;</span><span class="p">,</span>
            <span class="s2">&quot;overwrite&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="p">}</span>
<span class="p">]</span>

<span class="n">dump</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="p">(</span><span class="n">model_path</span> <span class="o">/</span> <span class="s2">&quot;modified_settings_2.toml&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;w&quot;</span><span class="p">))</span>
<span class="n">settings</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;time_framework&#39;: [2020, 2025, 2030, 2035, 2040, 2045, 2050],
 &#39;foresight&#39;: 5,
 &#39;regions&#39;: [&#39;R1&#39;],
 &#39;interest_rate&#39;: 0.1,
 &#39;interpolation_mode&#39;: &#39;Active&#39;,
 &#39;log_level&#39;: &#39;info&#39;,
 &#39;equilibrium_variable&#39;: &#39;demand&#39;,
 &#39;maximum_iterations&#39;: 100,
 &#39;tolerance&#39;: 0.1,
 &#39;tolerance_unmet_demand&#39;: -0.1,
 &#39;outputs&#39;: [{&#39;quantity&#39;: &#39;prices&#39;,
   &#39;sink&#39;: &#39;aggregate&#39;,
   &#39;filename&#39;: &#39;{cwd}/{default_output_dir}/MCA{Quantity}.csv&#39;},
  {&#39;quantity&#39;: &#39;capacity&#39;,
   &#39;sink&#39;: &#39;aggregate&#39;,
   &#39;filename&#39;: &#39;{cwd}/{default_output_dir}/MCA{Quantity}.csv&#39;}],
 &#39;carbon_budget_control&#39;: {&#39;budget&#39;: []},
 &#39;global_input_files&#39;: {&#39;projections&#39;: &#39;{path}/input/Projections.csv&#39;,
  &#39;global_commodities&#39;: &#39;{path}/input/GlobalCommodities.csv&#39;},
 &#39;sectors&#39;: {&#39;residential&#39;: {&#39;type&#39;: &#39;default&#39;,
   &#39;priority&#39;: 1,
   &#39;dispatch_production&#39;: &#39;share&#39;,
   &#39;technodata&#39;: &#39;{path}/technodata/residential/Technodata.csv&#39;,
   &#39;commodities_in&#39;: &#39;{path}/technodata/residential/CommIn.csv&#39;,
   &#39;commodities_out&#39;: &#39;{path}/technodata/residential/CommOut.csv&#39;,
   &#39;subsectors&#39;: {&#39;retro_and_new&#39;: {&#39;agents&#39;: &#39;{path}/technodata/Agents.csv&#39;,
     &#39;existing_capacity&#39;: &#39;{path}/technodata/residential/ExistingCapacity.csv&#39;,
     &#39;lpsolver&#39;: &#39;scipy&#39;,
     &#39;constraints&#39;: [&#39;max_production&#39;,
      &#39;max_capacity_expansion&#39;,
      &#39;demand&#39;,
      &#39;search_space&#39;],
     &#39;demand_share&#39;: &#39;new_and_retro&#39;,
     &#39;forecast&#39;: 5}},
   &#39;outputs&#39;: [{&#39;quantity&#39;: {&#39;name&#39;: &#39;consumption_zero&#39;,
      &#39;sum_over&#39;: &#39;timeslice&#39;},
     &#39;sink&#39;: {&#39;name&#39;: &#39;txt&#39;,
      &#39;filename&#39;: &#39;{cwd}/{default_output_dir}/{Sector}{Quantity}{year}{suffix}&#39;,
      &#39;msg&#39;: &#39;Hello, you!&#39;,
      &#39;overwrite&#39;: True}}],
   &#39;interactions&#39;: [{&#39;net&#39;: &#39;new_to_retro&#39;, &#39;interaction&#39;: &#39;transfer&#39;}]},
  &#39;power&#39;: {&#39;type&#39;: &#39;default&#39;,
   &#39;priority&#39;: 2,
   &#39;dispatch_production&#39;: &#39;share&#39;,
   &#39;technodata&#39;: &#39;{path}/technodata/power/Technodata.csv&#39;,
   &#39;commodities_in&#39;: &#39;{path}/technodata/power/CommIn.csv&#39;,
   &#39;commodities_out&#39;: &#39;{path}/technodata/power/CommOut.csv&#39;,
   &#39;subsectors&#39;: {&#39;retro_and_new&#39;: {&#39;agents&#39;: &#39;{path}/technodata/Agents.csv&#39;,
     &#39;existing_capacity&#39;: &#39;{path}/technodata/power/ExistingCapacity.csv&#39;,
     &#39;lpsolver&#39;: &#39;scipy&#39;}},
   &#39;outputs&#39;: [{&#39;filename&#39;: &#39;{cwd}/{default_output_dir}/{Sector}/{Quantity}/{year}{suffix}&#39;,
     &#39;quantity&#39;: &#39;capacity&#39;,
     &#39;sink&#39;: &#39;csv&#39;,
     &#39;overwrite&#39;: True}],
   &#39;interactions&#39;: [{&#39;net&#39;: &#39;new_to_retro&#39;, &#39;interaction&#39;: &#39;transfer&#39;}]},
  &#39;gas&#39;: {&#39;type&#39;: &#39;default&#39;,
   &#39;priority&#39;: 3,
   &#39;dispatch_production&#39;: &#39;share&#39;,
   &#39;technodata&#39;: &#39;{path}/technodata/gas/Technodata.csv&#39;,
   &#39;commodities_in&#39;: &#39;{path}/technodata/gas/CommIn.csv&#39;,
   &#39;commodities_out&#39;: &#39;{path}/technodata/gas/CommOut.csv&#39;,
   &#39;subsectors&#39;: {&#39;retro_and_new&#39;: {&#39;agents&#39;: &#39;{path}/technodata/Agents.csv&#39;,
     &#39;existing_capacity&#39;: &#39;{path}/technodata/gas/ExistingCapacity.csv&#39;,
     &#39;lpsolver&#39;: &#39;scipy&#39;}},
   &#39;outputs&#39;: [{&#39;filename&#39;: &#39;{cwd}/{default_output_dir}/{Sector}/{Quantity}/{year}{suffix}&#39;,
     &#39;quantity&#39;: &#39;capacity&#39;,
     &#39;sink&#39;: &#39;csv&#39;,
     &#39;overwrite&#39;: True}],
   &#39;interactions&#39;: [{&#39;net&#39;: &#39;new_to_retro&#39;, &#39;interaction&#39;: &#39;transfer&#39;}]},
  &#39;residential_presets&#39;: {&#39;type&#39;: &#39;presets&#39;,
   &#39;priority&#39;: 0,
   &#39;consumption_path&#39;: &#39;{path}/technodata/preset/*Consumption.csv&#39;}},
 &#39;timeslices&#39;: {&#39;all-year&#39;: {&#39;all-week&#39;: {&#39;night&#39;: 1460,
    &#39;morning&#39;: 1460,
    &#39;afternoon&#39;: 1460,
    &#39;early-peak&#39;: 1460,
    &#39;late-peak&#39;: 1460,
    &#39;evening&#39;: 1460}},
  &#39;level_names&#39;: [&#39;month&#39;, &#39;day&#39;, &#39;hour&#39;]}}
</pre></div></div>
</div>
<p>We then run the simulation again:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">mca</span> <span class="o">=</span> <span class="n">MCA</span><span class="o">.</span><span class="n">factory</span><span class="p">(</span><span class="n">model_path</span> <span class="o">/</span> <span class="s2">&quot;modified_settings_2.toml&quot;</span><span class="p">)</span>
<span class="n">mca</span><span class="o">.</span><span class="n">run</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
-- 2020-11-26 16:50:27 - muse.mca - WARNING
Check growth constraints for wind.

-- 2020-11-26 16:50:33 - muse.mca - WARNING
Check growth constraints for wind.

-- 2020-11-26 16:50:39 - muse.mca - WARNING
Check growth constraints for wind.

-- 2020-11-26 16:50:44 - muse.mca - WARNING
Check growth constraints for wind.

-- 2020-11-26 16:50:49 - muse.mca - WARNING
Check growth constraints for wind.

-- 2020-11-26 16:50:53 - muse.mca - WARNING
Check growth constraints for wind.

-- 2020-11-26 16:50:56 - muse.mca - WARNING
Check growth constraints for wind.

-- 2020-11-26 16:51:01 - muse.mca - WARNING
Check growth constraints for wind.

-- 2020-11-26 16:51:07 - muse.mca - WARNING
Check growth constraints for wind.

-- 2020-11-26 16:51:14 - muse.mca - WARNING
Check growth constraints for wind.

-- 2020-11-26 16:51:20 - muse.mca - WARNING
Check growth constraints for wind.

-- 2020-11-26 16:51:24 - muse.mca - WARNING
Check growth constraints for wind.

-- 2020-11-26 16:51:29 - muse.mca - WARNING
Check growth constraints for wind.

</pre></div></div>
</div>
<p>And we can check the parameters were used accordingly:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">all_txt_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">((</span><span class="n">Path</span><span class="p">()</span> <span class="o">/</span> <span class="s2">&quot;Results&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;Residential*.txt&quot;</span><span class="p">))</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_txt_files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">7</span>
<span class="k">assert</span> <span class="s2">&quot;Hello, you!&quot;</span> <span class="ow">in</span> <span class="n">all_txt_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>
<span class="n">all_txt_files</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[PosixPath(&#39;Results/ResidentialConsumption_Zero2020.txt&#39;),
 PosixPath(&#39;Results/ResidentialConsumption_Zero2025.txt&#39;),
 PosixPath(&#39;Results/ResidentialConsumption_Zero2030.txt&#39;),
 PosixPath(&#39;Results/ResidentialConsumption_Zero2035.txt&#39;),
 PosixPath(&#39;Results/ResidentialConsumption_Zero2040.txt&#39;),
 PosixPath(&#39;Results/ResidentialConsumption_Zero2045.txt&#39;),
 PosixPath(&#39;Results/ResidentialConsumption_Zero2050.txt&#39;)]
</pre></div></div>
</div>
<p>Again, we can see that the number of output files generated were as we expected and that our new message “Hello, you!” was found within these files. This means that our output and sink functions worked as expected.</p>
</div>
<div class="section" id="Next-steps">
<h2>Next steps<a class="headerlink" href="#Next-steps" title="Permalink to this headline">¶</a></h2>
<p>In the next section we will output a technology filter, to stop agents from investing in a certain technology, and a new metric to combine multiple objectives.</p>
</div>
</div>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Extending MUSE</a><ul>
<li><a class="reference internal" href="#Extending-outputs">Extending outputs</a><ul>
<li><a class="reference internal" href="#Output-extension">Output extension</a></li>
</ul>
</li>
<li><a class="reference internal" href="#Adding-TOML-parameters-to-the-outputs">Adding TOML parameters to the outputs</a></li>
<li><a class="reference internal" href="#Next-steps">Next steps</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="index.html"
                        title="previous chapter">Advanced guide</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="further-extending-muse.html"
                        title="next chapter">Further extending MUSE</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/advanced-guide/extending-muse.ipynb.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="further-extending-muse.html" title="Further extending MUSE"
             >next</a> |</li>
        <li class="right" >
          <a href="index.html" title="Advanced guide"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">MUSE Documentation 0.8 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Advanced guide</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Extending MUSE</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, Sustainable Gas Institute.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.1.2.
    </div>
  </body>
</html>