========
Overview
========

The model is organised in hierarchical manner. At the top resides the |mca|. It is
responsible for the market itself, including the carbon market if requested, and for
running sectors.

The market has the main goal of governing the prices of commodities, where a commodity is either a service demand 
like hot water in residential buildings or a fuel burned in a biomass boiler. The market ensures that 
a market equilibrium is reached. The market contains three components:

- prices of the commodities
- demand for commodities, as generated by the sectors
- production of commodities, as generated by the sectors

The |mca| views the sectors as black boxes that are given a market as input and return
another market giving their production and consumption of commodities, as well as the
prices of commodities they produce.

The |mca| proceeds either over-imposing a market-clearing approach on all commodities 
with user-defined exclusion (opting for the equilibrium mode) or imposing a forward price trajectory
for all commodities. If a cap on carbon emissions is enforced (opting for the carbon budget mode) then a carbon market is also enforced. the user can specify the commodities on which a cap can be applied.

In an equilibrium mode, for a given period, 
the |mca| iterates over the sectors until the market reaches an equilibrium in the foresight period (the period next to the one analysed), represented by a stable variation of 
commodity demand (or price) between iterations below a defined tolerance. If convergence is not met, then the |mca|
exits the loop until a maximum number of iteration is reached. 
When a carbon market is applied, then the |mca| samples a user-defined set of carbon prices  and estimate a polynomial regression model of the global emissions as a function of the carbon price. 

The new carbon price is estimated as a root of the regression model estimated at the value of the emission equal to the user-defined emission cap in the foresight period.
This price  is used to update the foward trajectory of prices from the next time period onwards. During the sampling and after the new arbon price is defined, then the |mca| enter in the equilibrium loop, keeping the carbon price constant and iterating over the selected commodity prices.

If nor the equilibrium or the budget mode are imposed then the |mca| applies a user-defined trajectory of prices for the whole time of the simulation. 

.. note::

   TODO: short description of |mca| cum carbon market.


Sectors are organised into Demand, Supply, and Conversion, where Demand
sectors consume energy, the Supply sector provide commodities required for producing
energy, and the conversion sectors produced energy in one form or another. In practice,
sectors take as input the current market and return another market with the sector's
consumption and production of commodities, and, optionally,  altered prices for the
commodities it is responsible for. From the point of view of the |mca|, 

The standard implementation for a sector revolves around agents. Agents represent the key players
in each energy sector. For example, they can represent risk-conservative oil companies
or innovators in the oil industry. 
Each agent can model a different region, or a diffent population with a specific
energy investment agenda. The sector's two main responsibilities are to (i) split the demand
for commodities it receives from the |mca| amongst the agents it owns, so that agents
can determine their investment schedule, and (ii) computing current and projected
consumption, production and price changes following investment.

The main role of agents is to own and invest in new assets. An asset is represented by a technology 
owned by an agent of a specific sector. For example, in the residential building sector, an
asset could be either a biomass boiler or an electric heater.

The investment algorithm
tries and models different behaviors and preferences observed in the real
world :cite:`2019:sachs`. As a
result, the standard implementation follows the following general schema, given as input
a forwad trajectory of demand to satisfy:

#. filter down the technologies an agent is willing to consider for investment, given a
   demand profile, it's current assets, the assets present in the sector as a whole, and
   it's own preferences
#. rate the technologies according to a given set of metrics
#. invest according to the input demand and the computed ratings


.. note::

   For historical reasons, in the current implementation, the job of splitting the
   demand given by the |mca| to the sector between the agents owned by the sector is not
   fully contained within the sector. The implementation is somewhat more complicated.
   The job of splitting the demand is done in part in the sector, and in part within
   each agent.


.. |mca| replace:: market-clearing algorithm
